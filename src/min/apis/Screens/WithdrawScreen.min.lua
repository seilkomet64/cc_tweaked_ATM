local a=require("basalt")local b=require("atmAPI")local c=require("Screens.selectionBase")local d=require("Screens.errorDialog")local e=require("Screens.confirmDialog")local f=require("Screens.acceptDialog")local g=require("itemManager")local function h(i)local j=0;local k=0;local l;local m;local n;local o;local p,q,r,s,t,u;local v=nil;function t()o:start(p)end;function p()while true do local w,x,y=os.pullEvent()if w=="key"then if x==keys.backspace then local z=tostring(j)z=z:sub(1,-2)if z==""then z="0"end;j=tonumber(z)or j;s(0)end;if x==keys.enter then r()end elseif w=="char"then local z=tostring(j)z=z..x;j=tonumber(z)or j;s(0)end end end;function q()local A,B,C,D;if not v then A,B,C,D=pcall(function()return b.withdraw(i.acc,k,i.pin)end)else A,B,C,D=true,"",v[1],v[2]v=nil end;k=0;if not A then local E=B:match(":%d+: (.+)")or B;if E=="Failed to contact the server!"then d(m,n,{"Server not reachable.","Try again later!"})elseif E=="Error: Incorrect PIN entered."then d(m,n,{"Incorrect PIN","Please try again."})else d(m,n,{"An error occurred: ",E})end else local F,G=pcall(function()return g.materializeItems(C)end)if F then b.confirmWithdrawal(i.acc,D)f(m,n,{"Please pick up your "..CONFIG.CURRENCYNAME.."s","from the Dropper!"},i)else d(m,n,{G,"Empty it and confirm again!"})v={C,D}end end end;function r()if j==0 then d(m,n,{"You can't withdraw nothing!"})elseif l<0 then d(m,n,{"You don't have enough "..CONFIG.COINNAME.."!"})else k=j;e(m,n,string.format("Withdraw %s %ss?",k,CONFIG.CURRENCYNAME),q)end end;m=c("Withdraw",r,i)n=m:getChild("mainContent")o=m:addThread()local H=n:addFrame():setSize("parent.w","parent.h * 0.7 - 1"):setBackground(colors.lightGray)local I;local A,J=pcall(function()return b.balance(i.acc,i.pin)end)if A then H:addLabel():setText("Your Balance will be"):setPosition("parent.w * 0.5 + 1 - self.w * 0.5",2)I=H:addLabel():setText(J):setPosition("parent.w * 0.5 + 1 - self.w * 0.5",4)else local E=J:match(":%d+: (.+)")or J;d(m,n,{E})end;H:addLabel():setText("How many "..CONFIG.CURRENCYNAME.."s do you want to withdraw?"):setPosition("parent.w * 0.5 + 1 - self.w * 0.5","parent.h - 1")local K=n:addFrame():setSize("parent.w",3):setPosition(1,"parent.h * 0.7"):setBackground(colors.lightGray)local L={5,3}local M=K:addLabel("amountLabel"):setText(0):setPosition("parent.w * 0.5 + 1 - self.w * 0.5",2)function s(N)j=j+N;if j<0 then j=0 end;M:setText(j)l=J-j*CONFIG.EXCHANGERATE;I:setText(l)if l<0 then I:setForeground(colors.red)else I:setForeground(colors.black)end end;K:addButton():setText("-64"):setSize(L[1],L[2]):setPosition(2):onClick(function()s(-64)end)K:addButton():setText("-16"):setSize(L[1],L[2]):setPosition(8):onClick(function()s(-16)end)K:addButton():setText("-1"):setSize(L[1],L[2]):setPosition(14):onClick(function()s(-1)end)K:addButton():setText("+1"):setSize(L[1],L[2]):setPosition("parent.w - 17"):onClick(function()s(1)end)K:addButton():setText("+16"):setSize(L[1],L[2]):setPosition("parent.w - 11"):onClick(function()s(16)end)K:addButton():setText("+64"):setSize(L[1],L[2]):setPosition("parent.w - 5"):onClick(function()s(64)end)t()return m end;return h
